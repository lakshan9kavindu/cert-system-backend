<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verify Certificates</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/utility.css">
  <style>
    body { padding: 0; margin: 0; font-family: 'Inter', sans-serif; }
    .header-bar {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px 40px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    .shell { max-width: 1100px; margin: 0 auto; padding: 0 20px 60px; }
    .chip { padding: 8px 16px; background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 999px; font-size: 13px; color: white; font-weight: 600; }
    .form-row { display: flex; gap: 12px; margin-bottom: 20px; align-items: stretch; }
    .logo { max-width: 120px; max-height: 120px; border: 2px solid #e5e7eb; border-radius: 8px; background: #f8fafc; padding: 8px; }
    .section-title { 
      font-weight: 700; 
      margin: 24px 0 16px; 
      color: #0f172a; 
      font-size: 18px;
      padding-bottom: 8px;
      border-bottom: 2px solid #e5e7eb;
    }
    .mono { font-family: 'Courier New', monospace; font-size: 13px; word-break: break-all; background: #f1f5f9; padding: 4px 8px; border-radius: 4px; }
    a.tx { color: #10b981; font-size: 13px; text-decoration: none; font-weight: 500; }
    a.tx:hover { text-decoration: underline; color: #059669; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 16px; }
    .label { 
      font-weight: 600; 
      color: #6b7280; 
      font-size: 11px; 
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .value { color: #111827; font-size: 14px; }
    .result-card {
      border-left: 4px solid #667eea;
      transition: all 0.3s;
      position: relative;
    }
    .result-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 30px rgba(102, 126, 234, 0.15);
    }
    .badge-container {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    @media (max-width: 640px) { .form-row { flex-direction: column; } .btn { width: 100%; } .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="header-bar">
    <div class="shell" style="padding: 0;">
      <div class="flex items-center justify-between gap-3">
        <div>
          <h1 class="text-2xl font-bold m-0" style="color: white; margin-bottom: 4px;">üîç Certificate Verification</h1>
          <p class="text-sm mt-2 m-0" style="color: rgba(255,255,255,0.9);">Validate certificates with blockchain-backed proof on Polygon Amoy</p>
        </div>
        <div class="chip">üåê Public Access</div>
      </div>
    </div>
  </div>
  
  <div class="shell">

    <div class="card">
      <div class="tab-group">
        <button class="tab active" id="tab-cert" onclick="switchTab('cert')">By Certificate ID</button>
        <button class="tab" id="tab-user" onclick="switchTab('user')">By User ID</button>
      </div>

      <div id="message" class="hidden mb-3 px-4 py-3 rounded-lg border"></div>

      <div id="form-cert">
        <div class="form-row">
          <input id="certIdInput" class="input" type="text" placeholder="Enter Certificate ID" />
          <button id="btnCert" class="btn btn-primary" onclick="verifyCert()">Verify</button>
        </div>
      </div>

      <div id="form-user" class="hidden">
        <div class="form-row">
          <input id="userIdInput" class="input" type="text" placeholder="Enter User ID" />
          <button id="btnUser" class="btn btn-primary" onclick="verifyUser()">Lookup</button>
        </div>
      </div>

      <div id="results"></div>
    </div>
  </div>

  <script>
    function switchTab(tab) {
      document.getElementById('tab-cert').classList.toggle('active', tab === 'cert');
      document.getElementById('tab-user').classList.toggle('active', tab === 'user');
      document.getElementById('form-cert').style.display = tab === 'cert' ? 'block' : 'none';
      document.getElementById('form-user').style.display = tab === 'user' ? 'block' : 'none';
      document.getElementById('results').innerHTML = '';
      hideMessage();
    }

    function showMessage(text, type = 'info') {
      const m = document.getElementById('message');
      m.textContent = text;
      m.className = type === 'error' ? 'block mb-3 px-4 py-3 rounded-lg border bg-red-50 text-red-600 border-red-200' : 'block mb-3 px-4 py-3 rounded-lg border bg-blue-50 text-blue-700 border-blue-200';
    }
    function hideMessage() { const m = document.getElementById('message'); m.className = 'hidden'; m.textContent = ''; }

    async function verifyCert() {
      const certId = document.getElementById('certIdInput').value.trim();
      if (!certId) { showMessage('Enter a certificate ID', 'error'); return; }
      disable('btnCert', true);
      hideMessage();
      document.getElementById('results').innerHTML = '';
      try {
        const res = await fetch(`/api/verify/certificate/${encodeURIComponent(certId)}`);
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Verification failed');
        renderCertResult(data.certificate, data.onchain);
      } catch (err) {
        showMessage(err.message, 'error');
      } finally { disable('btnCert', false); }
    }

    async function verifyUser() {
      const userId = document.getElementById('userIdInput').value.trim();
      if (!userId) { showMessage('Enter a user ID', 'error'); return; }
      disable('btnUser', true);
      hideMessage();
      document.getElementById('results').innerHTML = '';
      try {
        const res = await fetch(`/api/verify/user/${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Lookup failed');
        renderUserResults(data.student, data.certificates);
      } catch (err) {
        showMessage(err.message, 'error');
      } finally { disable('btnUser', false); }
    }

    function disable(id, val) { const el = document.getElementById(id); if (el) { el.disabled = val; el.textContent = val ? 'Working...' : (id==='btnCert'?'Verify':'Lookup'); } }

    let lastCert = null;
    let userCerts = [];

    function renderCertResult(cert, onchain) {
      lastCert = cert;
      const div = document.getElementById('results');
      const txLink = cert.blockchain_tx_hash ? `<a class="tx" target="_blank" href="https://amoy.polygonscan.com/tx/${cert.blockchain_tx_hash}">View on Polygonscan ‚Üí</a>` : '<span class="badge badge-warning" style="font-size: 11px;">‚è≥ Pending blockchain</span>';
      div.innerHTML = `
        <div class="card result-card mt-3 p-8">
          <div class="badge-container">
            <span class="badge badge-info">üìú Certificate</span>
            ${cert.blockchain_tx_hash ? '<span class="badge badge-success">‚úì On-chain Recorded</span>' : '<span class="badge badge-warning">‚è≥ Awaiting Blockchain</span>'}
            ${onchain && onchain.verified ? '<span class="badge badge-success">‚úì Verified</span>' : ''}
          </div>
          
          <div class="section-title">üìã Certificate Details</div>
          <div class="grid">
            <div><div class="label">Certificate ID</div><div class="mono">#${cert.certificate_id}</div></div>
            <div><div class="label">Title</div><div class="value">${cert.certificate_title || cert.course}</div></div>
            <div><div class="label">Course</div><div class="value">${cert.course}</div></div>
            <div><div class="label">Issued Date</div><div class="value">${new Date(cert.issued_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>
            ${cert.expiry_date ? `<div><div class="label">Expiry Date</div><div class="value">${new Date(cert.expiry_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>` : ''}
            ${cert.grade ? `<div><div class="label">Grade</div><div><span class="badge badge-info">${cert.grade}</span></div></div>` : ''}
          </div>
          
          <div style="margin: 20px 0; padding: 16px; background: #f8fafc; border-radius: 8px; border-left: 3px solid #10b981;">
            <div class="label" style="margin-bottom: 8px;">üîó Blockchain Transaction</div>
            <div>${txLink}</div>
          </div>

          <div class="section-title">üéì Student Information</div>
          <div class="grid">
            <div><div class="label">Full Name</div><div class="value">${cert.student_name}</div></div>
            <div><div class="label">Email Address</div><div class="value">${cert.student_email}</div></div>
            <div><div class="label">User ID</div><div class="mono">${cert.user_id}</div></div>
          </div>

          <div class="section-title">üè´ Issuing Institution</div>
          <div class="grid">
            <div><div class="label">Institute Name</div><div class="value">${cert.institute_name}</div></div>
            <div><div class="label">Wallet Address</div><div class="mono">${cert.issuer_wallet}</div></div>
            ${cert.logo_url ? `<div><div class="label">Institution Logo</div><div><img class="logo" src="${cert.logo_url}" alt="logo"></div></div>` : ''}
          </div>

          <div class="section-title">On-chain</div>
          <div>
            ${onchain && onchain.checked ? renderOnchain(onchain) : '<span class="mono">Not checked</span>'}
          </div>

          <div class="mt-6 pt-4" style="border-top: 1px solid #e5e7eb;">
            <button class="btn btn-primary" onclick="openPrintableSingle()" style="font-size: 14px;">üìÑ Download Certificate</button>
          </div>
        </div>
      `;
    }

    function renderOnchain(onchain) {
      if (onchain.error) return `<span class="text-red-600">Error: ${onchain.error}</span>`;
      if (!onchain.verified) return `<span class="text-yellow-600">Not found on-chain</span>`;
      let cmp = '';
      if (onchain.comparison && onchain.comparison.match !== undefined) {
        cmp = onchain.comparison.match ? '<span class="text-green-600">Data match</span>' : '<span class="text-red-600">Data mismatch</span>';
      }
      return `<span class="text-green-600">Verified on-chain</span> ${cmp ? '‚Äî ' + cmp : ''}`;
    }

    function renderUserResults(student, certificates) {
      const div = document.getElementById('results');
      userCerts = certificates;
      const certList = certificates.map(c => {
        const txLink = c.blockchain_tx_hash ? `<a class="tx" target="_blank" href="https://amoy.polygonscan.com/tx/${c.blockchain_tx_hash}">View TX ‚Üí</a>` : '<span class="badge badge-warning" style="font-size: 11px;">‚è≥ Pending</span>';
        return `
          <div class="card result-card mt-3 p-6">
            <div class="badge-container">
              <span class="badge badge-info">üìú ${c.certificate_title || c.course}</span>
              ${c.blockchain_tx_hash ? '<span class="badge badge-success">‚úì On-chain</span>' : '<span class="badge badge-warning">‚è≥ Pending</span>'}
              ${c.grade ? `<span class="badge badge-info">${c.grade}</span>` : ''}
            </div>
            <div class="grid">
              <div><div class="label">Certificate ID</div><div class="mono">#${c.certificate_id}</div></div>
              <div><div class="label">Course</div><div class="value">${c.course}</div></div>
              <div><div class="label">Issued Date</div><div class="value">${new Date(c.issued_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>
              ${c.expiry_date ? `<div><div class="label">Expiry Date</div><div class="value">${new Date(c.expiry_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>` : ''}
              <div><div class="label">Institution</div><div class="value">${c.institute_name}</div></div>
              <div><div class="label">Blockchain</div><div>${txLink}</div></div>
            </div>
            <div class="mt-4"><button class="btn btn-primary" onclick="openPrintableFromList(${certificates.indexOf(c)})">üìÑ Download Certificate</button></div>
          </div>
        `;
      }).join('');

      div.innerHTML = `
        <div class="card result-card p-8">
          <div class="badge-container">
            <span class="badge badge-success">üéì Student Profile</span>
            <span class="badge badge-info">${certificates.length} Certificate${certificates.length !== 1 ? 's' : ''}</span>
          </div>
          <div class="section-title">üë§ Student Information</div>
          <div class="grid">
            <div><div class="label">Full Name</div><div class="value">${student.full_name}</div></div>
            <div><div class="label">Email Address</div><div class="value">${student.email}</div></div>
            <div><div class="label">User ID</div><div class="mono">${student.user_id}</div></div>
            ${student.gender ? `<div><div class="label">Gender</div><div class="value">${student.gender}</div></div>` : ''}
            ${student.birthdate ? `<div><div class="label">Date of Birth</div><div class="value">${new Date(student.birthdate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</div></div>` : ''}
          </div>
          <div class="section-title">üìö Issued Certificates (${certificates.length})</div>
          ${certificates.length ? certList : '<div>No certificates</div>'}
        </div>
      `;
    }

    function buildPrintableHTML(cert) {
      return `
        <html><head><title>Certificate ${cert.certificate_id}</title>
        <style>
          body { font-family: 'Segoe UI', sans-serif; padding:40px; background:#f7f7f7; }
          .card { background:#fff; border:1px solid #ddd; padding:24px; border-radius:12px; max-width:800px; margin:0 auto; }
          .header { display:flex; justify-content:space-between; align-items:center; }
          .logo { max-height:80px; max-width:140px; }
          h1 { margin:12px 0 4px 0; }
          .mono { font-family: monospace; }
        </style>
        </head><body onload="window.print()">
          <div class="card">
            <div class="header">
              <div>
                <div style="color:#667eea; font-weight:700;">Certificate</div>
                <h1>${cert.certificate_title || cert.course || ''}</h1>
                <div style="color:#555;">${cert.institute_name || ''}</div>
              </div>
              ${cert.logo_url ? `<img class="logo" src="${cert.logo_url}" />` : ''}
            </div>
            <p style="margin-top:16px;">Awarded to <strong>${cert.student_name || cert.student_email || ''}</strong></p>
            <p>Course: <strong>${cert.course || ''}</strong></p>
            <p>Issued: ${cert.issued_date ? new Date(cert.issued_date).toLocaleDateString() : ''}</p>
            ${cert.expiry_date ? `<p>Expiry: ${new Date(cert.expiry_date).toLocaleDateString()}</p>` : ''}
            ${cert.grade ? `<p>Grade: ${cert.grade}</p>` : ''}
            <p class="mono">Certificate ID: ${cert.certificate_id}</p>
            ${cert.blockchain_tx_hash ? `<p class="mono">TX: ${cert.blockchain_tx_hash}</p>` : ''}
          </div>
        </body></html>`;
    }

    function openPrintableSingle() {
      if (!lastCert) return;
      const w = window.open('', '_blank');
      w.document.write(buildPrintableHTML(lastCert));
      w.document.close();
    }

    function openPrintableFromList(idx) {
      const cert = userCerts[idx];
      if (!cert) return;
      const w = window.open('', '_blank');
      w.document.write(buildPrintableHTML(cert));
      w.document.close();
    }
  </script>
</body>
</html>
