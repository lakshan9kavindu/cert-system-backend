<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verify Certificates</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/utility.css">
  <style>
    body { padding: 1.75rem 1rem 3rem; }
    .shell { max-width: 1100px; margin: 0 auto; }
    .chip { padding: 0.5rem 0.75rem; background: #eef2ff; border: 1px solid #e0e7ff; border-radius: 999px; font-size: 0.8125rem; color: #4338ca; }
    .form-row { display: flex; gap: 0.625rem; margin-bottom: 0.75rem; align-items: center; }
    .logo { max-width: 7.5rem; max-height: 7.5rem; border: 1px solid #e5e7eb; border-radius: 0.5rem; background: #f8fafc; padding: 0.375rem; }
    .section-title { font-weight: 700; margin: 0.625rem 0 0.375rem; color: #0f172a; letter-spacing: 0.1px; }
    .mono { font-family: 'Inter', monospace; font-size: 0.8125rem; word-break: break-all; }
    a.tx { color: #1d4ed8; font-size: 0.75rem; text-decoration: none; }
    a.tx:hover { text-decoration: underline; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(13.125rem, 1fr)); gap: 0.625rem; }
    .label { font-weight: 600; color: #6b7280; font-size: 0.8125rem; }
    @media (max-width: 640px) { .form-row { flex-direction: column; } .btn { width: 100%; } }
  </style>
</head>
<body>
  <div class="shell">
    <div class="hero flex items-center justify-between gap-3">
      <div>
        <h1 class="text-2xl font-bold m-0">Trustless Certificate Verification</h1>
        <p class="text-sm text-gray-500 mt-2 m-0">Validate by certificate ID or user ID with on-chain proof on Polygon Amoy.</p>
      </div>
      <div class="chip">Public • No login required</div>
    </div>

    <div class="card">
      <div class="tab-group">
        <button class="tab active" id="tab-cert" onclick="switchTab('cert')">By Certificate ID</button>
        <button class="tab" id="tab-user" onclick="switchTab('user')">By User ID</button>
      </div>

      <div id="message" class="hidden mb-3 px-4 py-3 rounded-lg border"></div>

      <div id="form-cert">
        <div class="form-row">
          <input id="certIdInput" class="input" type="text" placeholder="Enter Certificate ID" />
          <button id="btnCert" class="btn btn-primary" onclick="verifyCert()">Verify</button>
        </div>
      </div>

      <div id="form-user" class="hidden">
        <div class="form-row">
          <input id="userIdInput" class="input" type="text" placeholder="Enter User ID" />
          <button id="btnUser" class="btn btn-primary" onclick="verifyUser()">Lookup</button>
        </div>
      </div>

      <div id="results"></div>
    </div>
  </div>

  <script>
    function switchTab(tab) {
      document.getElementById('tab-cert').classList.toggle('active', tab === 'cert');
      document.getElementById('tab-user').classList.toggle('active', tab === 'user');
      document.getElementById('form-cert').style.display = tab === 'cert' ? 'block' : 'none';
      document.getElementById('form-user').style.display = tab === 'user' ? 'block' : 'none';
      document.getElementById('results').innerHTML = '';
      hideMessage();
    }

    function showMessage(text, type = 'info') {
      const m = document.getElementById('message');
      m.textContent = text;
      m.className = type === 'error' ? 'block mb-3 px-4 py-3 rounded-lg border bg-red-50 text-red-600 border-red-200' : 'block mb-3 px-4 py-3 rounded-lg border bg-blue-50 text-blue-700 border-blue-200';
    }
    function hideMessage() { const m = document.getElementById('message'); m.className = 'hidden'; m.textContent = ''; }

    async function verifyCert() {
      const certId = document.getElementById('certIdInput').value.trim();
      if (!certId) { showMessage('Enter a certificate ID', 'error'); return; }
      disable('btnCert', true);
      hideMessage();
      document.getElementById('results').innerHTML = '';
      try {
        const res = await fetch(`/api/verify/certificate/${encodeURIComponent(certId)}`);
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Verification failed');
        renderCertResult(data.certificate, data.onchain);
      } catch (err) {
        showMessage(err.message, 'error');
      } finally { disable('btnCert', false); }
    }

    async function verifyUser() {
      const userId = document.getElementById('userIdInput').value.trim();
      if (!userId) { showMessage('Enter a user ID', 'error'); return; }
      disable('btnUser', true);
      hideMessage();
      document.getElementById('results').innerHTML = '';
      try {
        const res = await fetch(`/api/verify/user/${encodeURIComponent(userId)}`);
        const data = await res.json();
        if (!res.ok || !data.success) throw new Error(data.error || 'Lookup failed');
        renderUserResults(data.student, data.certificates);
      } catch (err) {
        showMessage(err.message, 'error');
      } finally { disable('btnUser', false); }
    }

    function disable(id, val) { const el = document.getElementById(id); if (el) { el.disabled = val; el.textContent = val ? 'Working...' : (id==='btnCert'?'Verify':'Lookup'); } }

    let lastCert = null;
    let userCerts = [];

    function renderCertResult(cert, onchain) {
      lastCert = cert;
      const div = document.getElementById('results');
      const txLink = cert.blockchain_tx_hash ? `<a class="tx" target="_blank" href="https://amoy.polygonscan.com/tx/${cert.blockchain_tx_hash}">${cert.blockchain_tx_hash}</a>` : '<span class="text-yellow-600">Pending</span>';
      div.innerHTML = `
        <div class="card mt-3">
          <div class="flex gap-2 flex-wrap mb-3">
            <span class="badge-info">Certificate</span>
            ${cert.blockchain_tx_hash ? '<span class="badge-success">On-chain recorded</span>' : '<span class="badge-warning">Awaiting chain</span>'}
            ${onchain && onchain.verified ? '<span class="badge-success">Verified</span>' : ''}
          </div>
          <div class="section-title">Certificate</div>
          <div class="grid">
            <div><div class="label">Certificate ID</div><div class="mono">${cert.certificate_id}</div></div>
            <div><div class="label">Title</div><div>${cert.certificate_title || cert.course}</div></div>
            <div><div class="label">Course</div><div>${cert.course}</div></div>
            <div><div class="label">Issued</div><div>${new Date(cert.issued_date).toLocaleDateString()}</div></div>
            ${cert.expiry_date ? `<div><div class="label">Expiry</div><div>${new Date(cert.expiry_date).toLocaleDateString()}</div></div>` : ''}
            ${cert.grade ? `<div><div class="label">Grade</div><div>${cert.grade}</div></div>` : ''}
            <div><div class="label">TX Hash</div><div>${txLink}</div></div>
          </div>

          <div class="section-title">Student</div>
          <div class="grid">
            <div><div class="label">Name</div><div>${cert.student_name}</div></div>
            <div><div class="label">Email</div><div>${cert.student_email}</div></div>
            <div><div class="label">User ID</div><div class="mono">${cert.user_id}</div></div>
          </div>

          <div class="section-title">Institute</div>
          <div class="grid">
            <div><div class="label">Name</div><div>${cert.institute_name}</div></div>
            <div><div class="label">Wallet</div><div class="mono">${cert.issuer_wallet}</div></div>
            <div><div class="label">Logo</div><div>${cert.logo_url ? `<img class="logo" src="${cert.logo_url}" alt="logo">` : 'No logo'}</div></div>
          </div>

          <div class="section-title">On-chain</div>
          <div>
            ${onchain && onchain.checked ? renderOnchain(onchain) : '<span class="mono">Not checked</span>'}
          </div>

          <div class="mt-3">
            <button class="btn btn-secondary" onclick="openPrintableSingle()">Download / Print</button>
          </div>
        </div>
      `;
    }

    function renderOnchain(onchain) {
      if (onchain.error) return `<span class="text-red-600">Error: ${onchain.error}</span>`;
      if (!onchain.verified) return `<span class="text-yellow-600">Not found on-chain</span>`;
      let cmp = '';
      if (onchain.comparison && onchain.comparison.match !== undefined) {
        cmp = onchain.comparison.match ? '<span class="text-green-600">Data match</span>' : '<span class="text-red-600">Data mismatch</span>';
      }
      return `<span class="text-green-600">Verified on-chain</span> ${cmp ? '— ' + cmp : ''}`;
    }

    function renderUserResults(student, certificates) {
      const div = document.getElementById('results');
      userCerts = certificates;
      const certList = certificates.map(c => {
        const txLink = c.blockchain_tx_hash ? `<a class="tx" target="_blank" href="https://amoy.polygonscan.com/tx/${c.blockchain_tx_hash}">${c.blockchain_tx_hash}</a>` : '<span class="text-yellow-600">Pending</span>';
        return `
          <div class="card mt-3">
            <div class="grid">
              <div><div class="label">Certificate</div><div class="mono">${c.certificate_id}</div></div>
              <div><div class="label">Title</div><div>${c.certificate_title || c.course}</div></div>
              <div><div class="label">Course</div><div>${c.course}</div></div>
              <div><div class="label">Issued</div><div>${new Date(c.issued_date).toLocaleDateString()}</div></div>
              ${c.expiry_date ? `<div><div class="label">Expiry</div><div>${new Date(c.expiry_date).toLocaleDateString()}</div></div>` : ''}
              ${c.grade ? `<div><div class="label">Grade</div><div>${c.grade}</div></div>` : ''}
              <div><div class="label">Institute</div><div>${c.institute_name}</div></div>
              <div><div class="label">TX</div><div>${txLink}</div></div>
            </div>
            <div class="mt-3"><button class="btn btn-secondary" onclick="openPrintableFromList(${certificates.indexOf(c)})">Download / Print</button></div>
          </div>
        `;
      }).join('');

      div.innerHTML = `
        <div class="card mt-3">
          <div class="section-title">Student</div>
          <div class="grid">
            <div><div class="label">Name</div><div>${student.full_name}</div></div>
            <div><div class="label">Email</div><div>${student.email}</div></div>
            <div><div class="label">User ID</div><div class="mono">${student.user_id}</div></div>
            <div><div class="label">Gender</div><div>${student.gender || ''}</div></div>
            <div><div class="label">Birthdate</div><div>${student.birthdate ? new Date(student.birthdate).toLocaleDateString() : ''}</div></div>
          </div>
          <div class="section-title">Certificates (${certificates.length})</div>
          ${certificates.length ? certList : '<div>No certificates</div>'}
        </div>
      `;
    }

    function buildPrintableHTML(cert) {
      return `
        <html><head><title>Certificate ${cert.certificate_id}</title>
        <style>
          body { font-family: 'Segoe UI', sans-serif; padding:40px; background:#f7f7f7; }
          .card { background:#fff; border:1px solid #ddd; padding:24px; border-radius:12px; max-width:800px; margin:0 auto; }
          .header { display:flex; justify-content:space-between; align-items:center; }
          .logo { max-height:80px; max-width:140px; }
          h1 { margin:12px 0 4px 0; }
          .mono { font-family: monospace; }
        </style>
        </head><body onload="window.print()">
          <div class="card">
            <div class="header">
              <div>
                <div style="color:#667eea; font-weight:700;">Certificate</div>
                <h1>${cert.certificate_title || cert.course || ''}</h1>
                <div style="color:#555;">${cert.institute_name || ''}</div>
              </div>
              ${cert.logo_url ? `<img class="logo" src="${cert.logo_url}" />` : ''}
            </div>
            <p style="margin-top:16px;">Awarded to <strong>${cert.student_name || cert.student_email || ''}</strong></p>
            <p>Course: <strong>${cert.course || ''}</strong></p>
            <p>Issued: ${cert.issued_date ? new Date(cert.issued_date).toLocaleDateString() : ''}</p>
            ${cert.expiry_date ? `<p>Expiry: ${new Date(cert.expiry_date).toLocaleDateString()}</p>` : ''}
            ${cert.grade ? `<p>Grade: ${cert.grade}</p>` : ''}
            <p class="mono">Certificate ID: ${cert.certificate_id}</p>
            ${cert.blockchain_tx_hash ? `<p class="mono">TX: ${cert.blockchain_tx_hash}</p>` : ''}
          </div>
        </body></html>`;
    }

    function openPrintableSingle() {
      if (!lastCert) return;
      const w = window.open('', '_blank');
      w.document.write(buildPrintableHTML(lastCert));
      w.document.close();
    }

    function openPrintableFromList(idx) {
      const cert = userCerts[idx];
      if (!cert) return;
      const w = window.open('', '_blank');
      w.document.write(buildPrintableHTML(cert));
      w.document.close();
    }
  </script>
</body>
</html>
