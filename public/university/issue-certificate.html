<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Issue Certificate - University Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/css/utility.css">
  <style>
    body { font-family: 'Inter', sans-serif; display: flex; }
    .sidebar { width: 240px; background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); color: #fff; display: flex; flex-direction: column; padding: 24px 20px; box-shadow: 4px 0 20px rgba(0,0,0,0.08); position: sticky; top: 0; height: 100vh; }
    .sidebar h1 { font-size: 20px; margin-bottom: 24px; }
    .sidebar .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; margin-bottom: 8px; border-radius: 8px; color: #fff; text-decoration: none; background: rgba(255,255,255,0.06); transition: background 0.2s; font-size: 14px; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { background: rgba(255,255,255,0.12); }
    .sidebar .logout-btn { margin-top: auto; background: rgba(255,255,255,0.16); border: 1px solid rgba(255,255,255,0.3); color: #fff; padding: 10px 12px; border-radius: 8px; cursor: pointer; font-size: 14px; }
    .main { flex: 1; padding: 24px 28px; }
    
    .form-group {
      margin-bottom: 24px;
    }

    .form-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      background: #fff;
    }

    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-group small {
      display: block;
      margin-top: 6px;
      color: #888;
      font-size: 12px;
    }

    .submit-btn {
      width: 100%;
      padding: 14px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .submit-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .info-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      border-radius: 12px;
      color: white;
      margin-bottom: 24px;
    }

    .info-card h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .info-card p {
      font-size: 13px;
      opacity: 0.95;
      line-height: 1.6;
    }

    .note-box {
      background: #f0f4ff;
      border-left: 4px solid #667eea;
      padding: 16px;
      border-radius: 8px;
      margin-top: 30px;
    }

    .note-box strong {
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 8px;
    }

    .note-box p {
      color: #555;
      font-size: 13px;
      line-height: 1.7;
      margin: 0;
    }

    .blockchain-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      margin-top: 8px;
    }

    .message {
      padding: 12px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .message.error {
      background-color: #fee;
      color: #c00;
      display: block;
    }

    .message.success {
      background-color: #efe;
      color: #060;
      display: block;
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        position: relative;
        width: 100%;
        height: auto;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        padding: 16px;
      }

      .sidebar h1 {
        width: 100%;
        margin-bottom: 8px;
      }

      .sidebar .nav-link {
        flex: 1 1 30%;
        justify-content: center;
      }

      .sidebar .logout-btn {
        width: 100%;
      }

      .main {
        padding: 16px;
      }
    }
  </style>
</head>
<body class="bg-gray">
  <div class="sidebar">
    <h1>üè´ University</h1>
    <a href="/university/overview.html" class="nav-link">üìä Overview</a>
    <a href="/university/issue-certificate.html" class="nav-link active">üìú Issue Certificate</a>
    <a href="/university/bulk-upload.html" class="nav-link">üì§ Bulk Upload</a>
    <a href="/university/history.html" class="nav-link">üìö History</a>
    <a href="/university/wallet.html" class="nav-link">üí∞ Wallet</a>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="main">
    <div class="card mb-6" style="padding: 20px 24px;">
      <h1 class="text-2xl font-semibold mb-2">Issue Single Certificate</h1>
      <p class="text-gray-600 text-sm">Manually issue a certificate to a student</p>
    </div>

    <div style="max-width: 800px; margin: 0 auto;">
      <!-- Info Card -->
      <div class="info-card">
        <h3>üîê Blockchain-Verified Certificate</h3>
        <p>Issue tamper-proof certificates stored securely on the blockchain. Each certificate is cryptographically signed and permanently recorded.</p>
        <div class="blockchain-badge">‚õìÔ∏è Polygon Network</div>
      </div>

      <div class="card p-8 mb-6">
        <div id="issueMessage" class="message"></div>

        <form id="issueCertForm">
          <div class="form-group">
            <label for="student_id">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                <circle cx="12" cy="7" r="4"/>
              </svg>
              Student ID *
            </label>
            <input type="text" id="student_id" name="student_id" placeholder="e.g., STU123456" required>
            <small>Enter the registered student ID (starts with STU)</small>
          </div>

          <div class="form-group">
            <label for="course_name">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/>
                <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/>
              </svg>
              Course/Program Name *
            </label>
            <input type="text" id="course_name" name="course_name" placeholder="e.g., Bachelor of Computer Science" required>
            <small>Full name of the course or degree program</small>
          </div>

          <div class="form-group">
            <label for="grade">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              Grade/Score *
            </label>
            <input type="text" id="grade" name="grade" placeholder="e.g., A+, 95%, First Class" required>
            <small>Final grade or score achieved by the student</small>
          </div>

          <button type="submit" class="submit-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="12" y1="18" x2="12" y2="12"/>
              <line x1="9" y1="15" x2="15" y2="15"/>
            </svg>
            Issue Certificate
          </button>
        </form>

        <div class="note-box">
          <strong>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="12" y1="16" x2="12" y2="12"/>
              <line x1="12" y1="8" x2="12.01" y2="8"/>
            </svg>
            Important Information
          </strong>
          <p>
            The certificate will be permanently stored on the blockchain and cannot be modified after issuance. 
            Please verify all details are correct before submitting. Students can view, download, and share 
            their certificates instantly after issuance.
          </p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script>
    let provider = null;
    let signer = null;
    let signerAddress = null;

    // Check authentication
    window.addEventListener('load', async () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/university/login';
        return;
      }
    });

    async function ensureWallet() {
      if (!window.ethereum) {
        throw new Error('MetaMask not found');
      }
      if (!provider) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
      }
      const accounts = await provider.send('eth_requestAccounts', []);
      signer = provider.getSigner();
      signerAddress = await signer.getAddress();
      return accounts;
    }

    // Issue single certificate with MetaMask signature, relayer submit
    document.getElementById('issueCertForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const student_id = document.getElementById('student_id').value.trim();
      const course_name = document.getElementById('course_name').value.trim();
      const grade = document.getElementById('grade').value.trim();

      if (!student_id || !course_name || !grade) {
        showMessage('All fields required', 'error');
        return;
      }

      const btn = e.target.querySelector('.submit-btn');
      btn.disabled = true;
      btn.textContent = 'Issuing...';

      try {
        const token = localStorage.getItem('token');
        if (!token) throw new Error('Not authenticated');

        // Ensure wallet & signer
        await ensureWallet();

        // 1) Get payload to sign
        const payloadResp = await fetch('/api/university/certificate/sign-payload', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ student_id, course_name, grade })
        });

        const payload = await payloadResp.json();
        if (!payloadResp.ok) {
          throw new Error(payload.error || 'Failed to prepare signature payload');
        }

        // 2) MetaMask signs message_hash
        const signature = await signer.signMessage(ethers.utils.arrayify(payload.message_hash));

        // 3) Relay via backend
        const issueResp = await fetch('/api/university/certificate/issue-signed', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            certificate_id: payload.certificate_id,
            student_id,
            course_name,
            grade,
            issued_date: payload.issued_date,
            signer_address: payload.signer_address,
            message_hash: payload.message_hash,
            signature
          })
        });

        const result = await issueResp.json();
        if (!issueResp.ok) {
          throw new Error(result.error || 'Failed to issue certificate');
        }

        const certId = result.certificate.certificate_id;
        const txHash = result.certificate.blockchain.transactionHash;
        showMessage(`‚úÖ Certificate issued successfully!\n\nüìú Certificate ID: ${certId}\n‚õìÔ∏è Transaction: ${txHash.substring(0, 10)}...${txHash.substring(txHash.length - 8)}`, 'success');
        document.getElementById('issueCertForm').reset();
        
        // Scroll to message
        document.getElementById('issueMessage').scrollIntoView({ behavior: 'smooth', block: 'center' });
      } catch (error) {
        showMessage('Error: ' + error.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Issue Certificate';
      }
    });

    function showMessage(text, type) {
      const el = document.getElementById('issueMessage');
      el.textContent = text;
      el.className = 'message ' + type;
    }

    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('institute_id');
      localStorage.removeItem('institute_name');
      window.location.href = '/';
    }
  </script>
</body>
</html>
